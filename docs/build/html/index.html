<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Singularity Builder’s documentation &#8212; Singularity Images 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="Singularity Images 0.1.0 documentation" href="#" />
    <link rel="next" title="Singularity Builder’s __main__" href="modules/singulartiy_builder.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="singularity-builder-s-documentation">
<h1>Singularity Builder&#8217;s documentation<a class="headerlink" href="#singularity-builder-s-documentation" title="Permalink to this headline">¶</a></h1>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules/singulartiy_builder.html">Singularity Builder&#8217;s __main__</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/singulartiy_builder.gitlab_tools.html">GitLab Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/singulartiy_builder.image_recipe_tools.html">Image Recipe Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/singulartiy_builder.singulartiy_builder.html">Singularity Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests/test_gitlab_tools.html">Unit tests for the Gitlab Tools Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests/test_image_recipe_tools.html">Unit Tests for the Image Recipe Tools module.</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests/test_singulartiy_builder.html">Unit Tests for Singularity Builder Class</a></li>
</ul>
</div>
<div class="section" id="singularity-autobuilder">
<h2>Singularity Autobuilder<a class="headerlink" href="#singularity-autobuilder" title="Permalink to this headline">¶</a></h2>
<p>The Singularity Autobuilder is intended to automate the building process of a collection of
Singularity recipes. It is, as of jet, intended to be started in a GitLab CI/CD Pipeline.</p>
<div class="section" id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>Singularity Autobuilder depends on the python packages:</dt>
<dd><ul class="first last simple">
<li><cite>GitPython</cite> to determine changes
of recipes contained in a local git repository.</li>
<li><cite>iso8601</cite> to convert date-strings from a GitLab API into date objects.</li>
<li><cite>requests</cite> to make calls to the GitLab v3 API.</li>
<li><cite>typing</cite> to write python3 type hints.</li>
</ul>
</dd>
</dl>
<p>It furthermore needs an installation of Singularity itself and
an installation of the Singularity Registry Client.</p>
<div class="section" id="singularity">
<h4>Singularity<a class="headerlink" href="#singularity" title="Permalink to this headline">¶</a></h4>
<p>To build images, <strong>Singularity</strong> itself needs to be installed.
It runs natively on linux and there exists an official
<a class="reference external" href="https://singularity.lbl.gov/install-linux">linux installation guide</a>.</p>
<p>Mac OSX and Windows user need to
run Singularity in a virtualized linux environment.
There are official guides to setup a Vagrant box wit Singularity:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://singularity.lbl.gov/install-mac">Mac OSX Singularity Vagrant guide</a></li>
<li><a class="reference external" href="https://singularity.lbl.gov/install-windows">Windows Singularity Vagrant guide</a></li>
</ul>
</div></blockquote>
<p>Singularity itself must be run with root privileges in order to build images,
meaning that the Autobuilder needs to be run with root privileges.</p>
<p>For information about singularity itself visit the
<a class="reference external" href="https://github.com/singularityware/singularity">GitHub-repository of singularity</a>
or the
<a class="reference external" href="https://singularity.lbl.gov/">official documentation of singularity</a>.</p>
</div>
<div class="section" id="singularity-registry-client">
<h4>Singularity Registry Client<a class="headerlink" href="#singularity-registry-client" title="Permalink to this headline">¶</a></h4>
<p>To interact with an sregistry,
the <strong>Singularity global client</strong> has to be installed and set up as
Singularity Registry Client.</p>
<p><a class="reference external" href="https://singularityhub.github.io/sregistry-cli/client-registry">Singularity Global Client installation and user
Guide</a></p>
<p>The client is able to work with local and external storage.
The default behavior for the client is to work with local storage.
For the client to enable its functionality to work with an sregistry,
the environment variable <cite>SREGISTRY_CLIENT</cite> has to be set like so:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SREGISTRY_CLIENT</span><span class="o">=</span><span class="n">registry</span>
</pre></div>
</div>
<p>To authenticate the sregistry-client against an sregistry and to
set the registries hostname an sregistry secrets file is needed.
The secrets file is a json file containing the following:</p>
<div class="code json highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;registry&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;authentication_token&quot;</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;sregistry_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;base&quot;</span><span class="p">:</span> <span class="s2">&quot;https://myregistry.com&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Your sregistry instance can generate this file for every user with the
correct privileges. To set up a user, that is able to push images,
first <a class="reference external" href="https://singularityhub.github.io/sregistry/setup#create-accounts">set up a user able to administrate the sregistry</a>.
Then follow the instructions given by the <a class="reference external" href="https://singularityhub.github.io/sregistry/credentials.html">credentials guide page</a></p>
<p>The sregistry expects the credentials file at $HOME/.sregistry.
The location can be changed by defining a different path in the
<cite>SREGISTRY_CLIENT_SECRETS</cite> environment variable.</p>
<dl class="docutils">
<dt>For further information about the sregisty client see:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="https://singularityhub.github.io/sregistry-cli/">Documentation for the client</a></li>
<li><a class="reference external" href="https://singularityhub.github.io/sregistry-cli/client-registry">Tutorial for the client working with a registry</a></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="installation-from-git-repository">
<h3>Installation from Git Repository<a class="headerlink" href="#installation-from-git-repository" title="Permalink to this headline">¶</a></h3>
<p>Clone latest stable version of the Repository:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="o">-</span><span class="n">b</span> <span class="n">v0</span><span class="o">.</span><span class="mf">1.0</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">MPIB</span><span class="o">/</span><span class="n">SingularityAutobuild</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>Install with pip:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">SingularityAutobuild</span>
<span class="n">pip</span> <span class="n">install</span> <span class="p">[</span><span class="o">--</span><span class="n">user</span><span class="p">]</span> <span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<p>The Autobuild process was designed to work in a GitLab CI/CD Pipeline.
It expects several environment variables to be set. Those variables
are intended to be set by creating Secret variables in the GitLab
CI/CD settings.</p>
<p>Variables to be set are:</p>
<blockquote>
<div><ul class="simple">
<li>GITLAB_API_STRING: The GitLAb API-v3-URL for the events of the repository
containing the recipes.</li>
<li>GITLAB_API_TOKEN: The authentication token for the GitLab API.</li>
</ul>
</div></blockquote>
<p>The autobuild process uses the GitLab API information to only build
recipes that have changed during the latest push to the repository.
The process will fail, if the variable is not set or if there is no API
to call (if the recipes in general are not hosted on a GitLab instance).</p>
<div class="section" id="running-without-gitlab-ci-cd">
<h4>Running without GitLab CI/CD<a class="headerlink" href="#running-without-gitlab-ci-cd" title="Permalink to this headline">¶</a></h4>
<p>If the GitLab variables are set and
Singularity and the sregistry client are set up,
the autobuild process can be started through its entry-point:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">singularity_autobuild</span> <span class="o">--</span><span class="n">path</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">recipe</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">folder</span> <span class="o">--</span><span class="n">image_type</span> <span class="n">IMAGE_TYPE</span>
</pre></div>
</div>
</div>
<div class="section" id="running-with-gitlab-ci-cd">
<h4>Running with GitLab CI/CD<a class="headerlink" href="#running-with-gitlab-ci-cd" title="Permalink to this headline">¶</a></h4>
<p>The docker image <a class="reference external" href="https://hub.docker.com/r/hansend/sregistry-builder/">hansend/sregistry-builder:Autobuilder-0.1.0</a>
builds upon the <a class="reference external" href="https://hub.docker.com/_/python/">python:3.7-rc-stretch</a>
image and has Singularity,
the sregistry client and the Autobuilder already installed.
It can be used in a GitLab CI/CD pipeline.
The container is also set up to build an .sregistry
file to identify the sregistry client against the registry.
For this to work the environment variable</p>
<blockquote>
<div><ul class="simple">
<li><cite>SREGISTRY_HOSTNAME</cite>: Host address of the sregistry</li>
<li><cite>SREGISTRY_USERNAME</cite>: Name of the sregistry user</li>
<li><cite>SREGISTRY_TOKEN</cite>: Authentication token of the user,
found in the sregistry admin interface or in the users .sregistry file.</li>
</ul>
</div></blockquote>
<p>have to be set.
The best way to set the variables is through the secret variables
in the GitLab CI/CD settings.</p>
<p>The following is a .gitlab-ci.yml pipeline config
that creates a <cite>.sregistry</cite> file in the <cite>before_script</cite>
section of the build_image job.</p>
<div class="code yaml highlight-default"><div class="highlight"><pre><span></span><span class="n">image</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">hansend</span><span class="o">/</span><span class="n">sregistry</span><span class="o">-</span><span class="n">builder</span><span class="p">:</span><span class="n">Autobuilder</span><span class="o">-</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>

<span class="n">build_images</span><span class="p">:</span>
  <span class="n">stage</span><span class="p">:</span> <span class="n">deploy</span>
<span class="c1"># Create the .sregistry file to authenticate the user at the sregistry.</span>
  <span class="n">before_script</span><span class="p">:</span>
   <span class="o">-</span> <span class="s2">&quot;source /sregistry_file&quot;</span>
   <span class="o">-</span> <span class="s2">&quot;echo $SREGISTRY_USERNAME&quot;</span>
   <span class="o">-</span> <span class="s2">&quot;echo $SREGISTRY_FILE &gt; ~/.sregistry&quot;</span>
  <span class="n">script</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">singularity_autobuild</span> <span class="o">--</span><span class="n">path</span> <span class="o">./</span><span class="n">recipes</span> <span class="o">--</span><span class="n">image_type</span> <span class="n">simg</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="testing">
<h3>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h3>
<p>Test the main Builder Class and the __main__ module:</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">unittest</span> <span class="o">-</span><span class="n">v</span> <span class="n">singularity_autobuild</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">test_singularity_builder</span>
</pre></div>
</div>
<p>Test the module, that provides functionality
to work with the GitLab repository.</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">unittest</span> <span class="o">-</span><span class="n">v</span> <span class="n">singularity_autobuild</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">test_gitlab_tools</span>
</pre></div>
</div>
<p>Test the module, that provides functionality
to work with recipe files and created images.</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">unittest</span> <span class="o">-</span><span class="n">v</span> <span class="n">singularity_autobuild</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">test_image_recipe_tools</span>
</pre></div>
</div>
</div>
<div class="section" id="full-documentation">
<h3>Full Documentation<a class="headerlink" href="#full-documentation" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://mpib.github.io/SingularityAutobuild/">GiHub Pages</a></p>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Singularity Builder&#8217;s documentation</a><ul>
<li><a class="reference internal" href="#singularity-autobuilder">Singularity Autobuilder</a><ul>
<li><a class="reference internal" href="#dependencies">Dependencies</a><ul>
<li><a class="reference internal" href="#singularity">Singularity</a></li>
<li><a class="reference internal" href="#singularity-registry-client">Singularity Registry Client</a></li>
</ul>
</li>
<li><a class="reference internal" href="#installation-from-git-repository">Installation from Git Repository</a></li>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#running-without-gitlab-ci-cd">Running without GitLab CI/CD</a></li>
<li><a class="reference internal" href="#running-with-gitlab-ci-cd">Running with GitLab CI/CD</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#full-documentation">Full Documentation</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
      <li>Next: <a href="modules/singulartiy_builder.html" title="next chapter">Singularity Builder&#8217;s __main__</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Dominique Hansen.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.9</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="_sources/index.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>